# Пакет: com.example.chatee2e.data.local

Даний пакет виконує роль центрального адміністратора локальних ресурсів додатка. Він об'єднує опис бази даних та механізми керування станом активної сесії користувача, забезпечуючи життєвий цикл даних від ініціалізації до їх гарантованого видалення.

## Основні компоненти

### 1. AppDatabase (Абстрактний клас бази даних)
Об'єкт, що базується на бібліотеці **Room**, і є точкою доступу до реляційних даних застосунку.
* **Конфігурація**: Клас об'єднує сутності `ChatEntity` та `MessageEntity` у єдину схему бази даних.
* **Доступ до DAO**: Надає абстрактні методи для отримання екземплярів `ChatDao` та `MessageDao`, які використовуються репозиторіями для маніпуляції даними.
* **Безпека**: Інстанс `AppDatabase` створюється із застосуванням **SQLCipher**, що дозволяє прозоро шифрувати весь файл бази даних алгоритмом AES-256.



### 2. SessionManager (Менеджер сесії та кешування)
Клас із анотацією `@Singleton`, що відповідає за збереження тимчасових даних та ідентифікаторів у пам'яті та `SharedPreferences`.

#### Керування секретами та ідентифікаторами:
* **databasePassphrase**: Змінна типу `ByteArray?`, позначена анотацією `@Volatile`. Вона зберігає розшифрований пароль від бази даних у оперативній пам'яті після проходження біометричної автентифікації. Використання `@Volatile` гарантує, що всі потоки бачать актуальний стан ключа.
* **saveUserId / getUserId**: Забезпечує збереження унікального ідентифікатора поточного користувача у системних налаштуваннях. Це дозволяє додатку ідентифікувати власника пристрою при кожному запуску без повторного запиту до сервера.

#### Кешування криптографічних даних:
* **publicKeyCache**: Внутрішня структура `MutableMap`, що зберігає публічні ключі RSA інших користувачів у форматі Base64. Кешування дозволяє уникати повторних мережевих запитів до Firestore перед шифруванням кожного повідомлення.

## Ключові алгоритми та процеси

### Процедура очищення сесії (clearSession)
Ця функція реалізує механізм "гарантованого забуття" та є критично важливою для безпеки. Процес включає:
1.  **Очищення оперативної пам'яті**: Виклик `fill(0)` для масиву `databasePassphrase` фізично перезаписує нулями пароль бази даних перед його видаленням, що запобігає його відновленню через дамп пам'яті.
2.  **Очищення кешу**: Повне видалення завантажених публічних ключів ідентифікації.
3.  **Стирання налаштувань**: Метод видаляє всі налаштування користувача з `SharedPreferences`.
4.  **Фізичне видалення бази даних**: Видалення файлів бази даних (`chatee2e_db`) разом із допоміжними файлами журналу транзакцій (`-shm`, `-wal`). Це гарантує, що після виходу з акаунта на пристрої не залишається жодного фрагмента зашифрованої переписки.



## Контекст використання та безпека
* **Управління залежностями**: Клас використовує **Hilt** для впровадження залежностей, що забезпечує дотримання принципу єдиної відповідальності.
* **Потокобезпечність**: Робота із сесією передбачає доступ із різних фонових потоків, тому методи доступу розроблені з урахуванням багатопотоковості Kotlin Coroutines.