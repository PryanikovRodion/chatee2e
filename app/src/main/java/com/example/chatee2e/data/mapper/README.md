# Пакет: com.example.chatee2e.data.mapper

Даний пакет відповідає за реалізацію логіки перетворення (mapping) даних між різними шарами архітектури застосунку: мережевим шаром (**Remote**), шаром локального зберігання (**Local/Database**) та шаром бізнес-логіки (**Domain**).

Використання функцій-маперів дозволяє ізолювати доменні моделі від специфіки реалізації зовнішніх API та схем баз даних, забезпечуючи чистоту архітектури та незалежність шарів.

## Основні функції та логіка перетворень

### 1. Трансформація даних користувача та чатів
Мапери забезпечують конвертацію об'єктів передачі даних (DTO) у моделі, придатні для відображення та постійного зберігання:
* **UserDto.toDomain(id)**: Перетворює мережеву модель користувача у доменний об'єкт `User`. Функція приймає зовнішній `id`, оскільки в системі Firestore ідентифікатор є ключем документа, а не полем всередині об'єкта.
* **ChatDto.toEntity(id, participantsJson)**: Трансформує дані чату з сервера у сутність `ChatEntity` для бази даних Room.
    * **Особливість**: параметр `participantsJson` передається як серіалізований рядок, оскільки SQLite не підтримує збереження колекцій (List), що вимагає попередньої обробки даних перед записом.
* **ChatEntity.toDomain(participants)**: Відновлює об'єкт `Chat` із локальної бази даних. Часова мітка останнього повідомлення конвертується з типу `Long` у об'єкт `Date` для коректної роботи бізнес-логіки та UI.

### 2. Трансформація повідомлень (Критичний шлях)
Процес мапування повідомлень інтегрований із криптографічним шаром:
* **MessageDto.toEntity(...)**: Виконується виключно після того, як текст повідомлення було дешифровано.
    * **Контекст**: приймає дешифрований текст (`decryptedText`), ім'я відправника та логічний прапорець `isMine`.
    * **Обробка часу**: реалізовано захисний механізм — якщо серверна мітка часу (`timestamp`) відсутня, мапер автоматично встановлює поточний системний час пристрою.
* **MessageEntity.toDomain()**: Конвертує локальну сутність повідомлення у доменну модель `Message`. Забезпечує безпечне значення за замовчуванням ("Unknown") для імені відправника, гарантуючи відсутність помилок при відображенні.



## Технічні особливості реалізації

1. **Функції розширення (Extension Functions)**: Мапери реалізовані як `extension` функції Kotlin. Це дозволяє викликати трансформацію безпосередньо на об'єктах даних (наприклад, `dto.toDomain()`), що робить код лаконічним.
2. **Атомарність операцій**: Мапери не виконують логічних перевірок або шифрування. Їхнє завдання — суто структурна зміна формату даних. Це дозволяє легко тестувати трансформації окремо від репозиторіїв.
3. **Ізоляція моделей**:presentation-шар та domain-шар працюють виключно з моделями `User`, `Chat` та `Message`. Це гарантує, що будь-які зміни в структурі документів Firebase або таблиць Room не призведуть до необхідності модифікації коду інтерфейсу.